@model IEnumerable<LMS.Models.User>

@{
    ViewBag.Title = "Manage Users";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int totalUsers = ViewBag.TotalUsers ?? 0;
    int itemsPerPage = ViewBag.ItemsPerPage ?? 5;
}


@Styles.Render("~/Content/manageUser.css")
<link rel="stylesheet" href="~/Content/Site.css" />

<div class="admin-container">

    <div class="page-header">
        <h1>User Account Management</h1>
        <p class="subtitle">Create new accounts, update existing user information, or delete accounts</p>
    </div>

    <!-- Create account dropdown -->
    <div class="create-dropdown mb-3">
        <button class="dropdown-toggle" type="button" id="createAccountMenu" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fa-solid fa-user-plus"></i> Create Account
        </button>
        <ul class="dropdown-menu" aria-labelledby="createAccountMenu">
            <li>
                <a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#roleSelectionModal" href="#">
                    <i class="fa-solid fa-pen-to-square"></i> Create Manually
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
                    <i class="fa-solid fa-file-excel"></i> Import from Excel
                </a>
            </li>
        </ul>
    </div>

    <!-- Role Selection Modal -->
    <div class="modal fade" id="roleSelectionModal" tabindex="-1" aria-labelledby="roleSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roleSelectionModalLabel">
                        <i class="fa-solid fa-user-plus"></i> Select Account Type
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Choose the type of account you want to create:</p>
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-primary btn-lg role-choice-btn" data-role="Student">
                            <i class="fa-solid fa-user-graduate me-2"></i> Student Account
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-lg role-choice-btn" data-role="Teacher">
                            <i class="fa-solid fa-chalkboard-user me-2"></i> Teacher Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Account Modal -->
    <div class="modal fade" id="manualAccountModal" tabindex="-1" aria-labelledby="manualAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="manualAccountModalLabel">
                        <i class="fa-solid fa-pen-to-square"></i>
                        <span id="modalTitle">Create Account Manually</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">

                    @if (TempData["FormError"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fa-solid fa-circle-exclamation me-2"></i>
                            @TempData["FormError"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div id="formErrorContainer" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
                        <i class="fa-solid fa-circle-exclamation me-2"></i>
                        <span id="formErrorMessage"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>

                    <form id="createAccountForm"
                          data-create-url="@Url.Action("CreateAccount", "Account")"
                          data-edit-url="@Url.Action("EditAccount", "Account")"
                          data-get-user-url="@Url.Action("GetUserData", "Account")">

                        @Html.AntiForgeryToken()

                        <!-- Hidden ID for editing -->
                        <input type="hidden" id="editId" name="id" />

                        <!-- Hidden role field (set by role selection modal) -->
                        <input type="hidden" id="role" name="role" />

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" id="firstName" name="firstName" class="form-control" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Last Name</label>
                                <input type="text" id="lastName" name="lastName" class="form-control" required>
                            </div>
                        </div>

                        <div class=" mb-3">
                            <label for="userId" class="form-label">Student/Teacher's ID</label>
                            <input type="text" id="userId" name="userId" class="form-control" required>
                        </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" id="email" name="email" class="form-control" required>
                            </div>


                        
                        <!-- Student-specific fields (hidden by default) -->
                            <div id="studentFieldsContainer" style="display: none;">
                                <div class=" mb-3">
                                    <label for="semester" class="form-label">Semester <span class="text-danger">*</span></label>
                                    <select id="semester" name="semester" class="form-select">
                                        <option value="" selected disabled>Choose semester</option>
                                        <option value="1">1st</option>
                                        <option value="2">2nd</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="program" class="form-label">Program <span class="text-danger">*</span></label>
                                    <select id="program" name="programId" class="form-select" required>
                                        <option value="" selected disabled>Choose Program</option>
                                        @foreach (var p in ViewBag.Programs)
                                        {
                                            <option value="@p.Id">
                                                @LMS.Helpers.ProgramNameHelper.AbbreviateProgramName(p.ProgramName)
                                            </option>
                                        }
                                    </select>
                                </div>



                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="studentYearLevel" class="form-label">Year Level <span class="text-danger">*</span></label>
                                        <select id="yearLevel" name="yearLevel" class="form-select" disabled>
                                            <option value="">Choose year level</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="studentSection" class="form-label">Section <span class="text-danger">*</span></label>
                                        <select id="studentSection" name="sectionId" class="form-select" disabled>
                                            <option value="">Choose section</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                    </form>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitAccountBtn" form="createAccountForm">
                        <i id="uploadIcon" class="fa-solid fa-upload me-1"></i>
                        <span id="btnText">Create</span>
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- Excel Upload Modal -->
    <div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-labelledby="uploadExcelModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content rounded-0">
                <form id="excelUploadForm" action="@Url.Action("UploadAccounts", "Account")" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadExcelModalLabel">
                            <i class="fa-solid fa-file-excel"></i> Import Accounts from Excel
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" id="uploadModalClose"></button>
                    </div>

                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="roleSelect" class="form-label">Select Account Type</label>
                            <select class="form-select" id="roleSelect" name="role" required>
                                <option value="">Choose...</option>
                                <option value="Student">Student</option>
                                <option value="Teacher">Teacher</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Upload Excel File (.xlsx)</label>
                            <input type="file" name="file" id="excelFile" class="form-control" accept=".xlsx" required>
                        </div>

                        <!-- Simplified Progress Section -->
                        <div id="uploadProgressSection" class="mb-3" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong id="progressTitle">Processing Excel File...</strong>
                                    <span id="progressPercent">0%</span>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="small">
                                    <span id="progressStatus">Starting upload...</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0 small" id="uploadInstructions">
                            <h6 class="mb-1"><i class="fa-solid fa-circle-info"></i> Excel Format Guide</h6>
                            <p>Excel columns (in order):</p>
                            <ul>
                                <li>Column 1 — ID</li>
                                <li>Column 2 — Last Name</li>
                                <li>Column 3 — First Name</li>
                                <li>Column 4 — Email</li>
                            </ul>
                            <p><strong>Password:</strong> auto-generated for each user.</p>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn cancel-btn" data-bs-dismiss="modal" id="uploadCancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="uploadSubmitBtn">
                            <i class="fa-solid fa-upload"></i> <span id="uploadBtnText">Upload</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <div class="admin-content ">

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="filter-controls">
                <input type="text" id="searchInput" class="search-input" placeholder="Search users by Name, Department, or Email" />

                <div class="filter-dropdowns">
                    <select class="filter-select">
                        <option value="">Role</option>
                        <option value="professor">Professor</option>
                        <option value="student">Student</option>
                        <option value="admin">Admin</option>
                    </select>

                    <select class="filter-select">
                        <option value="">Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="default-table-container">
            <table class="default-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="userTableBody" data-delete-url="@Url.Action("DeleteUser", "Account")">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var user in Model)
                        {
                            <tr class="default-row">
                                <td class="default-info">
                                    <div class="user-details">
                                        <div class="user-name">@user.LastName @user.FirstName</div>
                                        <div class="user-email">@user.Email</div>
                                        <div class="user-phone">@user.UserID</div>
                                    </div>
                                </td>
                                <td><span class="role-tag role-student">@user.Role</span></td>
                                <td>
                                    <span class="status-badge status-active">
                                        Active
                                    </span>
                                </td>
                                <td class="last-login">
                                    @if (user.LastLogin == null)
                                    {
                                        <div>New Account</div>
                                        <div class="login-time">Not logged in yet</div>
                                    }
                                    else
                                    {
                                        <div>@(user.LastLogin.Value.ToString("MM/dd/yyyy"))</div>
                                        <div class="login-time">@(user.LastLogin.Value.ToString("hh:mm tt"))</div>
                                    }
                                </td>
                                <td class="action-buttons">
                                    @if (user.Role != "Admin")
                                    {
                                        <button class="action-btn edit-btn" data-id="@user.Id" title="Edit">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>

                                        <button type="button" class="action-btn delete-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteModal"
                                                data-item-id="@user.Id"
                                                data-item-name="@($"{user.LastName} {user.FirstName}")"
                                                data-extra="@user.Role"
                                                data-target-remove=".default-row"
                                                data-url="@Url.Action("DeleteUser", "Account")"
                                                title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    }
                                </td>

                            </tr>


                        }
                    }
                    else
                    {
                        <tr id="noDataRow"><td colspan="6" class="text-center border-bottom-0">No students found.</td></tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Container for stacked alerts -->
        <div id="alertContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; max-width: 320px;"></div>

        <!-- Pagination Controls -->
        <div class="pagination-container">
            <div class="pagination-info">
                <span id="paginationInfo">Showing 1-5 of 0 entries</span>
                <span id="currentPageInfo" class="ms-3">Page 1 of 1</span>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevBtn">
                    <i class="fa-solid fa-chevron-left"></i> Previous
                </button>
                <div class="pagination-numbers" id="paginationNumbers">
                    <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn" id="nextBtn">
                    Next <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/Scripts/Custom/index.js"></script>
    <script src="~/Scripts/Custom/formValidation.js"></script>
    <script src="~/Scripts/Custom/deleteHandler.js"></script>
    <script src="~/Scripts/Custom/excelProgress.js"></script>
    <script src="~/Scripts/Custom/studentAccountDropdown.js"></script>
}

<style>
    /* Role Selection Modal Styles */
    #roleSelectionModal .modal-body {
        padding: 2rem;
    }

    .role-choice-btn {
        padding: 1.25rem;
        font-size: 1.1rem;
        font-weight: 500;
        border-width: 2px;
        transition: all 0.3s ease;
    }

    .role-choice-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .role-choice-btn i {
        font-size: 1.3rem;
    }

    #uploadProgressSection {
        animation: slideDown 0.3s ease-out;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
        }

        to {
            opacity: 1;
            max-height: 150px;
        }
    }

    .progress {
        transition: all 0.3s ease;
    }

    .progress-bar {
        transition: width 0.3s ease, background-color 0.3s ease;
    }

    #uploadProgressSection .alert {
        border-left: 4px solid #17a2b8;
    }

    .modal-footer button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>

