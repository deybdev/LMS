@{
    ViewBag.Title = "Sections";
}
@using LMS.Helpers
@model IEnumerable<LMS.Models.Section>

<link rel="stylesheet" href="~/Content/manageUser.css" />
<link rel="stylesheet" href="~/Content/adminAcademic.css" />

<div class="admin-container">
    <div class="page-header">
        <h1>Section Management</h1>
        <p class="subtitle">Manage academic sections and class groups</p>
    </div>

    <!-- Create Section Button -->
    <div class="create-dropdown mb-3">
        <button type="button" data-bs-toggle="modal" data-bs-target="#createSectionModal">
            <i class="fa-solid fa-plus"></i> Create Section
        </button>
    </div>

    <!-- Navigation Tabs -->
    <div class="admin-navigation">
        <div class="nav-tabs">
            <button class="nav-tab"
                    onclick="window.location.href='@Url.Action("Departments", "Admin")'">
                Department
            </button>
            <button class="nav-tab"
                    onclick="window.location.href='@Url.Action("Programs", "Admin")'">
                Program
            </button>
            <button class="nav-tab active"
                    onclick="window.location.href='@Url.Action("Sections", "Admin")'">
                Sections
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="admin-content">
        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="filter-controls">
                <input type="text" id="searchInput" class="search-input" placeholder="Search sections by name, program, or year level..." />

                <div class="filter-dropdowns">
                    <select class="filter-select" id="programFilter">
                        <option value="">All Programs</option>
                        @if (ViewBag.Programs != null)
                        {
                            foreach (var prog in ViewBag.Programs)
                            {
                                <option value="@prog.ProgramCode">@prog.ProgramCode</option>
                            }
                        }
                    </select>

                    <select class="filter-select" id="yearLevelFilter">
                        <option value="">All Year Levels</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                        <option value="5">5th Year</option>
                    </select>

                    <select class="filter-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Sections Table -->
        <div class="default-table-container">
            <table class="default-table">
                <thead>
                    <tr>
                        <th>Section Name</th>
                        <th>Program</th>
                        <th>Year Level</th>
                        <th>Date Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sectionTableBody">
                    @if (Model == null || !Model.Any())
                    {
                        <tr>
                            <td colspan="6" class="text-center">No sections found</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var s in Model)
                        {
                            string yearSuffix = s.YearLevel == 1 ? "st" : s.YearLevel == 2 ? "nd" : s.YearLevel == 3 ? "rd" : "th";
                            <tr class="default-row" data-program="@s.Program.ProgramCode" data-year="@s.YearLevel" data-status="Active">
                                <td class="default-info">
                                    <div class="user-details">
                                        <div class="user-name">@s.SectionName</div>
                                    </div>
                                </td>
                                <td><span class="role-tag">@s.Program.ProgramCode</span></td>
                                <td>@s.YearLevel@(yearSuffix) Year</td>
                                <td class="last-login">
                                    <div>@s.DateCreated.ToString("MM/dd/yyyy")</div>
                                    <div class="login-time">@s.DateCreated.ToString("hh:mm tt")</div>
                                </td>
                                <td class="action-buttons">
                                    <button class="action-btn edit-btn" data-id="@s.Id" title="Edit">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button type="button" class="action-btn delete-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal"
                                            data-item-id="@s.Id"
                                            data-item-name="@s.SectionName"
                                            data-url="@Url.Action("Delete", "Section")"
                                            data-target-remove=".default-row"
                                            title="Delete">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container">
            <div class="pagination-info">
                <span id="paginationInfo">Showing @(Model?.Count() ?? 0) of @(Model?.Count() ?? 0) entries</span>
                <span id="currentPageInfo" class="ms-3">Page 1 of 1</span>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevBtn" disabled>
                    <i class="fa-solid fa-chevron-left"></i> Previous
                </button>
                <div class="pagination-numbers" id="paginationNumbers">
                    <button class="pagination-number active">1</button>
                </div>
                <button class="pagination-btn" id="nextBtn" disabled>
                    Next <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="alertContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; max-width: 320px;"></div>

<!-- Create/Edit Section Modal -->
<div class="modal fade" id="createSectionModal" tabindex="-1" aria-labelledby="createSectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createSectionModalLabel">
                    <i class="fa-solid fa-users"></i> <span id="modalTitle">Create New Section</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div id="formErrorContainer" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
                    <i class="fa-solid fa-circle-exclamation me-2"></i>
                    <span id="formErrorMessage"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <form id="createSectionForm">
                    @Html.AntiForgeryToken()

                    <input type="hidden" id="sectionId" name="Id" />

                    <div class="mb-3">
                        <label for="sectionName" class="form-label">Section Name *</label>
                        <input type="text" id="sectionName" name="SectionName" class="form-control" required placeholder="e.g., A">
                    </div>

                    <div class="mb-3">
                        <label for="department" class="form-label">Department *</label>
                        <select id="department" class="form-select" required>
                            <option value="">Choose department</option>
                            @if (ViewBag.Departments != null)
                            {
                                foreach (var d in ViewBag.Departments)
                                {
                                    <option value="@d.Id">@d.DepartmentName</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="program" class="form-label">Program *</label>
                            <select id="program" name="ProgramId" class="form-select" required disabled>
                                <option value="" disabled selected>Choose program</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="yearLevel" class="form-label">Year Level *</label>
                            <select id="yearLevel" name="YearLevel" class="form-select" required disabled>
                                <option value="" disabled selected>Choose year level</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitSectionBtn" form="createSectionForm">
                    <i id="sectionIcon" class="fa-solid fa-save me-1"></i> <span id="btnText">Create</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/Scripts/Custom/deleteHandler.js"></script>
    <script src="~/Scripts/Custom/sectionDropdown.js"></script>
    <script src="~/Scripts/Custom/sectionManagement.js"></script>

    @if (TempData["SuccessMessage"] != null)
    {
        <script>
            $(function () {
                showAlert('success', '@TempData["SuccessMessage"]');
            });
        </script>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <script>
            $(function () {
                showAlert('danger', '@TempData["ErrorMessage"]');
            });
        </script>
    }

    <script>
        (function () {
            const $search = $('#searchInput');
            const $program = $('#programFilter');
            const $year = $('#yearLevelFilter');
            const $status = $('#statusFilter');
            const $rows = $('#sectionTableBody').find('tr.default-row');
            const $paginationInfo = $('#paginationInfo');

            function normalize(s) {
                return (s || '').toString().trim().toLowerCase();
            }

            function matchesFilters($row) {
                const q = normalize($search.val());

                const sectionName = normalize($row.find('.user-name').text());
                const programText = normalize($row.find('td .role-tag').text());
                const programAttr = normalize($row.data('program'));
                const yearAttr = ($row.data('year') || '').toString(); // numeric string
                const statusAttr = ($row.data('status') || 'Active').toString();

                const progFilter = $program.val() || '';
                const yearFilter = $year.val() || '';
                const statusFilter = $status.val() || '';

                // Text search: match Section Name OR Program text
                const textHit = !q || sectionName.includes(q) || programText.includes(q);

                // Program filter: match data attribute or visible text
                const progHit = !progFilter
                    || programAttr === normalize(progFilter)
                    || programText === normalize(progFilter);

                // Year filter: exact match on numeric year
                const yearHit = !yearFilter || yearAttr === yearFilter;

                // Status filter: default Active if missing
                const statusHit = !statusFilter || statusAttr === statusFilter;

                return textHit && progHit && yearHit && statusHit;
            }

            function applyFilters() {
                let shown = 0;
                $rows.each(function () {
                    const $row = $(this);
                    if (matchesFilters($row)) {
                        $row.show();
                        shown++;
                    } else {
                        $row.hide();
                    }
                });

                const total = $rows.length;
                $paginationInfo.text(`Showing ${shown} of ${total} entries`);
                // Do not modify pagination controls or logic; index.js handles pagination only.
            }

            // Wire up events
            $search.on('input', applyFilters);
            $program.on('change', applyFilters);
            $year.on('change', applyFilters);
            $status.on('change', applyFilters);

            // Initial apply
            applyFilters();
        })();
    </script>
}