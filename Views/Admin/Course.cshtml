@{
    ViewBag.Title = "Course Management";
    var studentCounts = ViewBag.StudentCounts as Dictionary<int, int>;
}

@model IEnumerable<LMS.Models.Course>

<link rel="stylesheet" href="~/Content/adminCourse.css" />

<div class="admin-container">

    <div class="page-header">
        <h1>Course Management</h1>
        <p class="subtitle">Monitor all courses, track enrollments, and manage course visibility</p>
    </div>
    <!-- Main Content -->
    <div class="admin-content">
        <!-- Filter and Search Section -->
        <div class="course-filter-section">


            <div class="filter-controls">
                <input type="text" id="courseSearchInput" class="search-input" placeholder="Search courses by title, teacher, or department..." />

                <div class="filter-dropdowns">
                    <select class="filter-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="archived">Archived</option>
                    </select>

                    <select class="filter-select" id="departmentFilter">
                        <option value="">All Departments</option>
                        <option value="ComputerStudies">Computer Studies</option>
                        <option value="InformationTechnology">Information Technology</option>
                        <option value="BusinessAdministration">Business Administration</option>
                        <option value="Engineering">Engineering</option>
                    </select>

                    <select class="filter-select" id="sortBy">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name">Course Name</option>
                        <option value="enrollments">Most Enrolled</option>
                        <option value="teacher">Teacher Name</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Courses Grid - 2 Cards Per Row -->
        <div class="courses-grid-container">
            @{
                var courseList = Model.ToList();
                for (int i = 0; i < courseList.Count; i += 2)
                {
                    <div class="courses-row">
                        @foreach (var course in courseList.Skip(i).Take(2))
                        {
                            
                            <div class="course-card" data-course-id="@course.Id" onclick="loadCourseDetails(@course.Id)">
                                <div class="course-header">
                                    <div class="course-main-info">
                                        <h3 class="course-title">@course.CourseTitle - @course.Section</h3>
                                        <div class="course-meta-row">
                                            <span class="course-code">@course.CourseCode</span>
                                            <span class="department-tag">@course.Teacher.Department</span>
                                            <span class="status-badge status-active">
                                                <i class="fas fa-circle"></i> Active
                                            </span>
                                        </div>
                                        <p class="course-description">
                                            @(string.IsNullOrWhiteSpace(course.Description) ? "No description provided" : course.Description)
                                        </p>
                                    </div>

                                    <div class="course-actions">
                                        <button class="action-btn more-btn" title="More Options">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="course-stats-row">
                                    <div class="stat-item">
                                        <div class="teacher-info">
                                            <i class="fas fa-user-tie"></i>
                                            <div class="teacher-details">
                                                <div class="teacher-name">
                                                    @if (course.Teacher != null)
                                                    {
                                                        @($"{course.Teacher.FirstName} {course.Teacher.LastName}")
                                                    }
                                                    else
                                                    {
                                                        @("Unknown Teacher")
                                                    }
                                                </div>
                                                <div class="teacher-email">@course.Teacher.Email</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="enrollment-info">
                                            <i class="fas fa-users"></i>
                                            <div class="enrollment-details">
                                                <div class="enrollment-count">
                                                    @course.CourseUsers.Count
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="course-footer">
                                    <div class="material-info">
                                        <i class="fas fa-file-alt"></i>
                                        <span class="material-count">
                                            @(course.Materials != null && course.Materials.Any()
                                            ? $"{course.Materials.Count()} materials"
                                            : "No materials")
                                        </span>
                                    </div>
                                    <div class="created-date">
                                        <i class="fas fa-calendar"></i>
                                        <span>Created @course.DateCreated.ToString("MMM dd, yyyy")</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>



        <!-- Pagination Controls -->
        <div class="pagination-container">
            <div class="pagination-info">
                <span id="paginationInfo">Showing 1-5 of 0 entries</span>
                <span id="currentPageInfo" class="ms-3">Page 1 of 1</span>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevBtn">
                    <i class="fa-solid fa-chevron-left"></i> Previous
                </button>
                <div class="pagination-numbers" id="paginationNumbers">
                    <!-- Page numbers will be generated here -->
                </div>
                <button class="pagination-btn" id="nextBtn">
                    Next <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Course Details Modal -->
<div class="modal fade" id="courseDetailsModal" tabindex="-1" aria-labelledby="courseDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courseDetailsModalLabel">
                    <i class="fas fa-book-open"></i> <span id="modalCourseTitle">Course Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Course Info Header -->
                <div class="modal-course-header">
                    <div class="course-info-section">
                        <div class="course-meta-info">
                            <span id="modalCourseCode" class="course-code">CS401</span>
                            <span id="modalDepartment" class="department-tag">Computer Studies</span>
                            <span id="modalStatus" class="status-badge status-active">
                                <i class="fas fa-circle"></i> Active
                            </span>
                        </div>
                        <p id="modalCourseDescription" class="course-description">Course description will appear here</p>
                        <div class="teacher-section">
                            <i class="fas fa-user-tie"></i>
                            <div class="teacher-info">
                                <div id="modalTeacherName" class="teacher-name">Teacher Name</div>
                                <div id="modalTeacherEmail" class="teacher-email">teacher@email.com</div>
                            </div>
                        </div>
                    </div>
                    <div class="course-stats-section">
                        <div class="stat-box">
                            <div class="stat-value" id="modalStudentCount">45</div>
                            <div class="stat-label">Students</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="modalMaterialCount">24</div>
                            <div class="stat-label">Materials</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="modalEngagementRate">87%</div>
                            <div class="stat-label">Engagement</div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="modal-tabs">
                    <nav class="tab-nav">
                        <button class="tab-btn active" onclick="showModalTab('students')">
                            <i class="fas fa-users"></i> Students
                        </button>
                        <button class="tab-btn" onclick="showModalTab('materials')">
                            <i class="fas fa-file-alt"></i> Materials
                        </button>
                    </nav>

                    <div class="tab-content">
                        <!-- Students Tab -->
                        <div id="modal-students-tab" class="tab-pane active">
                            <div class="students-header">
                                <h4>Enrolled Students</h4>
                                <div class="search-students">
                                    <input type="text" placeholder="Search students..." class="form-control">
                                </div>
                            </div>
                            <div class="students-list" id="modalStudentsList">
                                <!-- Students will be loaded here -->
                            </div>
                        </div>

                        <!-- Materials Tab -->
                        <div id="modal-materials-tab" class="tab-pane">
                            <div class="materials-header">
                                <h4>Course Materials</h4>
                                <div class="materials-filter">
                                    <select class="form-select">
                                        <option value="">All Types</option>
                                        <option value="pdf">PDFs</option>
                                        <option value="video">Videos</option>
                                        <option value="assignment">Assignments</option>
                                    </select>
                                </div>
                            </div>
                            <div class="materials-list" id="modalMaterialsList">
                                <!-- Materials will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <!-- Add jQuery before other scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
function loadCourseDetails(courseId) {
    // Clear previous modal content
    $('#modalCourseTitle').text('Loading...');
    $('#modalCourseCode').text('-');
    $('#modalDepartment').text('Unknown');
    $('#modalCourseDescription').text('Loading...');
    $('#modalTeacherName').text('Unknown Teacher');
    $('#modalTeacherEmail').text('N/A');
    $('#modalStudentCount').text('0');
    $('#modalMaterialCount').text('0');
    $('#modalEngagementRate').text('-');

    // Show the modal
    var modalEl = document.getElementById('courseDetailsModal');
    var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    $.ajax({
        url: '@Url.Action("GetCourseDetails", "Admin")',
        type: 'GET',
        data: { id: courseId },
        dataType: 'json',
        success: function (response) {
            if (!response || !response.success) return;

            // Populate course info
            $('#modalCourseTitle').text(response.title || 'No title');
            $('#modalCourseCode').text(response.code || '-');
            $('#modalDepartment').text(response.department || 'Unknown');
            $('#modalCourseDescription').text(response.description || 'No description provided');
            $('#modalTeacherName').text(response.teacherName || 'Unknown Teacher');
            $('#modalTeacherEmail').text(response.teacherEmail || 'N/A');
            $('#modalStudentCount').text(response.studentCount ?? 0);
            $('#modalMaterialCount').text(response.materialCount ?? 0);

            // Render students
            var studentsHtml = '<p class="text-muted">No students enrolled in this course.</p>';
            if (response.students?.length > 0) {
                studentsHtml = response.students.map(student => `
            <div class="student-item">
                <div class="student-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="student-info">
                    <div class="student-name">${student.firstName} ${student.lastName}</div>
                    <div class="student-id">${student.userId} - ${student.email}</div>
                </div>
            </div>
        `).join('');
            }
            $('#modalStudentsList').html(studentsHtml);

            // Render materials
            // Render materials
            var materialsHtml = '<p class="text-muted">No materials available for this course.</p>';
            if (response.materials?.length > 0) {
                materialsHtml = response.materials.map(mat => `
        <div class="material-item">
            <div class="material-left">
                <i class="fas fa-file-alt"></i>
                <div class="material-modal-info">
                    <div class="material-name">${mat.title || 'Untitled Material'}</div>
                    <div class="material-type">${mat.type || 'File'}</div>
                </div>
            </div>
            <div class="material-actions">
                <a href="${mat.files?.[0]?.filePath || '#'}" target="_blank" class="view-btn">View</a>
                <a href="${mat.files?.[0]?.filePath || '#'}" download class="download-btn">Download</a>
            </div>
        </div>
    `).join('');
            }
            $('#modalMaterialsList').html(materialsHtml);

        },

        error: function(xhr) {
            $('#modalCourseTitle').text('Error loading course');
            $('#modalCourseDescription').text('Please try again later.');
            alert('An error occurred while fetching course details.');
        }
    });
}

function showModalTab(tabName) {
    $('.tab-btn').removeClass('active');
    $('.tab-pane').removeClass('active');

    $(`button[onclick="showModalTab('${tabName}')"]`).addClass('active');
    $(`#modal-${tabName}-tab`).addClass('active');
}

$(document).ready(function() {
    if (typeof bootstrap === 'undefined') {
        console.warn('Bootstrap is NOT loaded');
    }
});

    </script>
}

<style>
/* Material List Styles */
.materials-list {
    display: flex;
    flex-direction: column;
    max-height: 400px;
    overflow-y: auto;
    padding-right: 6px;
}

.material-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #f9f9f9;
    transition: background 0.2s, box-shadow 0.2s;
}

.material-item:hover {
    background-color: #fff;
}

.material-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.material-left i.fa-file-alt {
    font-size: 28px;
    color: #1852AC;
    flex-shrink: 0;
}

.material-modal-info {
    display: flex;
    flex-direction: column;
}

.material-name {
    font-weight: 600;
    font-size: .85rem;
    color: #333;
}

.material-type {
    font-size: 0.875rem;
    color: #666;
}

.material-actions {
    display: flex;
    gap: 8px;
}

.material-actions a {
    font-size: 0.875rem;
    padding: 4px 8px;
    border-radius: 5px;
    text-decoration: none;
    color: #fff;
    transition: background 0.2s;
}

.view-btn {
    background-color: #949494;
    cursor: pointer;
}

.view-btn:hover {
    background-color: #6f6f6f;
    cursor: pointer;

}

.download-btn {
    background-color: #1852AC;
}

.download-btn:hover {
    background-color: #064B7A;
}


/* Scrollbar */
.materials-list::-webkit-scrollbar {
    width: 6px;
}

.materials-list::-webkit-scrollbar-thumb {
    background-color: rgba(0, 123, 255, 0.5);
    border-radius: 3px;
}

.materials-list::-webkit-scrollbar-track {
    background-color: #f1f1f1;
}

</style>