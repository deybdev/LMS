@{
    ViewData["Title"] = "Forgot Password";
    var currentStep = ViewBag.Step ?? 1;
}

<div class="login-page">
    <!--FORGOT PASSWORD CONTAINER-->
    <div class="login-container text-center">
        <img src="/images/logo.png" alt="" />
        <h1>School LMS</h1>
        <p id="stepDescription">
            @if (currentStep == 1)
            {
                <text>Enter your email address and we'll send you a reset code</text>
            }
            else if (currentStep == 2)
            {
                <text>Check your email and enter the 6-digit reset code</text>
            }
            else if (currentStep == 3)
            {
                <text>Create a strong new password for your account</text>
            }
        </p>

        <!-- Progress Indicator (hidden on success step) -->
        @if (currentStep < 4)
        {
            <div class="progress-steps">
                <div class="step @(currentStep >= 1 ? (currentStep == 1 ? "active" : "completed") : "")">
                    <span class="step-number">@(currentStep > 1 ? "" : "1")</span>
                    <span class="step-label">Email</span>
                </div>
                <div class="step-line @(currentStep > 1 ? "completed" : "")"></div>
                <div class="step @(currentStep >= 2 ? (currentStep == 2 ? "active" : "completed") : "")">
                    <span class="step-number">@(currentStep > 2 ? "" : "2")</span>
                    <span class="step-label">Code</span>
                </div>
                <div class="step-line @(currentStep > 2 ? "completed" : "")"></div>
                <div class="step @(currentStep >= 3 ? (currentStep == 3 ? "active" : "completed") : "")">
                    <span class="step-number">@(currentStep > 3 ? "" : "3")</span>
                    <span class="step-label">Password</span>
                </div>
            </div>
        }

        <!-- Error/Success Messages -->
        @if (ViewBag.Error != null)
        {
            <div class="alert alert-danger small p-2 mt-3 mb-1">@ViewBag.Error</div>
        }
        @if (ViewBag.Success != null)
        {
            <div class="alert alert-success small p-2 mt-3 mb-1">@ViewBag.Success <strong>@ViewBag.Email</strong>   </div>
        }

        @if (currentStep == 1)
        {
            <!-- Step 1: Email Input -->
            <form method="post" action="@Url.Action("ForgotPassword", "Account")" onsubmit="showLoading()">
                <label class="w-100 mt-2 text-start">
                    Email Address
                    <input type="email" name="email" class="form-control mb-3 mt-2" value="@ViewBag.Email" required />
                </label>

                <button type="submit" id="sendCodeBtn" class="login-form-btn w-100 d-flex justify-content-center align-items-center" style="gap:8px;">
                    <div id="sendCodeSpinner" class="spinner-border spinner-border-xs text-light" role="status" style="display:none;"></div>
                    <span id="sendCodeText">Send Reset Code</span>
                </button>
            </form>
        }
        else if (currentStep == 2)
        {
   
            <form method="post" action="@Url.Action("VerifyCode", "Account")" onsubmit="showVerifyLoading()">
                <input type="hidden" name="email" value="@ViewBag.Email" />
                
                <label class="w-100 text-start">
                    Reset Code
                    <input type="text" name="resetCode" class="form-control mb-3 mt-2 text-center" 
                           placeholder="Enter 6-digit code" maxlength="6" style="font-size: 1.2rem; letter-spacing: 0.3rem;" 
                           oninput="this.value = this.value.replace(/\D/g, ''); if(this.value.length > 6) this.value = this.value.slice(0,6);" />
                </label>

                <button type="submit" id="verifyCodeBtn" class="login-form-btn w-100 d-flex justify-content-center align-items-center" style="gap:8px;">
                    <div id="verifyCodeSpinner" class="spinner-border spinner-border-xs text-light" role="status" style="display:none;"></div>
                    <span id="verifyCodeText">Verify Code</span>
                </button>
            </form>
            
            <div class="mt-3">
                <form method="post" action="@Url.Action("ResendCode", "Account")" style="display: inline;">
                    <input type="hidden" name="email" value="@ViewBag.Email" />
                    <button type="submit" class="btn-link">Didn't receive code? Send again</button>
                </form>
            </div>
        }
        else if (currentStep == 3)
        {
            <!-- Step 3: New Password -->
            <form method="post" action="@Url.Action("ResetPasswordFinal", "Account")" onsubmit="showResetLoading()">
                <input type="hidden" name="email" value="@ViewBag.Email" />
                <input type="hidden" name="resetCode" value="@ViewBag.ResetCode" />

                <label class="w-100 text-start position-relative">
                    New Password
                    <input type="password" name="newPassword" id="newPasswordInput" class="form-control mt-2 mb-3" required />
                    <span id="toggleNewPassword" class="show-password-icon" onclick="togglePassword('newPasswordInput', this)">
                        <i class="fa fa-eye"></i>
                    </span>
                </label>

                <label class="w-100 text-start position-relative">
                    Confirm New Password
                    <input type="password" name="confirmPassword" id="confirmPasswordInput" class="form-control mt-2" required />
                    <span id="toggleConfirmPassword" class="show-password-icon-confirm" onclick="togglePassword('confirmPasswordInput', this)">
                        <i class="fa fa-eye"></i>
                    </span>
                </label>

                <button type="submit" id="resetPasswordBtn" class="login-form-btn w-100 d-flex justify-content-center align-items-center mt-3" style="gap:8px;">
                    <div id="resetPasswordSpinner" class="spinner-border spinner-border-xs text-light" role="status" style="display:none;"></div>
                    <span id="resetPasswordText">Reset Password</span>
                </button>
            </form>
        }
        else if (currentStep == 4)
        {
            <!-- Success Step (No Progress Steps) -->
            <div class="success-icon mt-4">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="mb-2">Password Reset Successful!</h3>
            <p class="mb-3">Your password has been updated successfully. You can now log in with your new password.</p>
            
            <a href="@Url.Action("Login", "Home")" class="login-form-btn w-100 d-flex justify-content-center align-items-center">
                Go to Login
            </a>
        }

        <!-- Back to Login Link (shown in first 3 steps) -->
        @if (currentStep < 4)
        {
            <div class="mt-3">
                <a href="@Url.Action("Login", "Home")" class="d-block">Back to Login</a>
            </div>
        }
    </div>
</div>

<style>
    .spinner-border {
        width: 1.5rem;
        height: 1.5rem;
    }

    /* Progress Steps */
    .progress-steps {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0 30px;
        padding: 0 20px;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #ccc;
        transition: all 0.3s ease;
    }

    .step.active {
        color: var(--primary-color);
    }

    .step.completed {
        color: #28a745;
    }

    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #f0f0f0;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 5px;
        transition: all 0.3s ease;
    }

    .step.active .step-number {
        background: var(--primary-color);
        color: white;
    }

    .step.completed .step-number {
        background: #28a745;
        color: white;
    }

    .step.completed .step-number::before {
        content: "✓";
    }

    .step.completed .step-number:empty::before {
        content: "✓";
    }

    .step-label {
        font-size: 0.8rem;
        font-weight: 500;
    }

    .step-line {
        flex: 1;
        height: 2px;
        background: #e0e0e0;
        margin: 0 10px;
        position: relative;
        top: -15px;
        transition: all 0.3s ease;
    }

    .step-line.completed {
        background: #28a745;
    }

    .success-message {
        color: #28a745;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .success-icon {
        font-size: 3rem;
        color: #28a745;
        margin-bottom: 20px;
    }

    .success-icon i {
        animation: checkmark 0.6s ease-in-out;
    }

    @@keyframes checkmark {
        0% { transform: scale(0); opacity: 0; }
        50% { transform: scale(1.2); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Show Password Icons */
    .show-password-icon, .show-password-icon-confirm {
        position: absolute;
        top: 73%;
        right: 15px;
        transform: translateY(-50%);
        cursor: pointer;
        color: #777;
        font-size: 1rem;
    }

    .show-password-icon:hover, .show-password-icon-confirm:hover {
        color: var(--primary-color);
    }

    /* Button Link Style */
    .btn-link {
        background: none;
        border: none;
        color: var(--primary-color);
        text-decoration: underline;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 0;
    }

    .btn-link:hover {
        color: var(--primary-hover);
        text-decoration: none;
    }

    /* Alert Styles */
    .alert {
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* MEDIA QUERIES FOR MOBILE */
    @@media (max-width: 767.98px) {
        .login-container {
            padding: 1.5rem 1.5rem;
            margin-bottom: 100px;
        }

        .login-container h1{
            font-size: 1.3rem;
        }

        .login-container p{
            font-size: .8rem;
        }

        .login-form-btn{
            font-size: .95rem;
            padding: .65rem .2rem;
        }

        .login-container img {
            width: 70px;
        }

        .progress-steps {
            padding: 0 10px;
        }

        .step-label {
            font-size: 0.7rem;
        }

        .step-line {
            margin: 0 5px;
        }
    }

    @@media (max-width: 575.98px) {
        .login-container {
            padding: 1rem 1rem;
            max-width: 90%;
        }

        .login-container h1{
            font-size: 1.2rem;
        }

        .login-container p{
            font-size: .75rem;
        }

        .login-container img {
            width: 60px;
        }
    }
</style>

<script>
    // Loading functions for different forms
    function showLoading() {
        const btn = document.getElementById('sendCodeBtn');
        const spinner = document.getElementById('sendCodeSpinner');
        const text = document.getElementById('sendCodeText');
        if (btn && spinner && text) {
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            text.textContent = 'Sending...';
        }
    }

    function showVerifyLoading() {
        const btn = document.getElementById('verifyCodeBtn');
        const spinner = document.getElementById('verifyCodeSpinner');
        const text = document.getElementById('verifyCodeText');
        if (btn && spinner && text) {
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            text.textContent = 'Verifying...';
        }
    }

    function showResetLoading() {
        const btn = document.getElementById('resetPasswordBtn');
        const spinner = document.getElementById('resetPasswordSpinner');
        const text = document.getElementById('resetPasswordText');
        if (btn && spinner && text) {
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            text.textContent = 'Resetting...';
        }
    }

    // Password visibility toggle
    function togglePassword(inputId, iconElement) {
        const input = document.getElementById(inputId);
        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
        input.setAttribute('type', type);
        iconElement.innerHTML = type === 'password' ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
    }
</script>