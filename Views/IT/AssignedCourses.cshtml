@model IEnumerable<LMS.Models.CurriculumGroupViewModel>

@{
    ViewBag.Title = "Assigned Courses";
}

<link rel="stylesheet" href="~/Content/teacherCreateCourse.css" />
<link rel="stylesheet" href="~/Content/manageUser.css" />
<link rel="stylesheet" href="~/Content/itCourse.css" />

<div class="admin-container">

    @Html.AntiForgeryToken()
    <div class="page-header">
        <h1>Course Curriculum</h1>
        <p class="subtitle">View and manage courses assigned to each Program, Year Level, and Semester</p>
    </div>

    <div class="header-actions">
        <button class="btn-create-class" onclick="window.location.href='@Url.Action("AssignCourse", "IT")'">
            <i class="fas fa-plus"></i> Assign Courses
        </button>
    </div>

    <!-- Filter Section -->
    <div class="admin-content" style="margin-bottom: 2rem;">

        <div class="search-filter-section">
            <div class="filter-controls">
                <input type="text" id="searchAssignments" class="search-input" placeholder="Search by program, year level, or semester..." />

                <div class="filter-dropdowns">
                    <select class="filter-select" id="programFilter">
                        <option value="">All Programs</option>
                        @if (Model != null && Model.Any())
                        {
                            var distinctPrograms = Model.GroupBy(g => g.ProgramCode).Select(g => g.First());
                            foreach (var group in distinctPrograms)
                            {
                                <option value="@group.ProgramCode">@group.ProgramCode - @group.ProgramName</option>
                            }
                        }
                    </select>

                    <select class="filter-select" id="yearLevelFilter">
                        <option value="">All Year Levels</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>

                    <select class="filter-select" id="semesterFilter">
                        <option value="">All Semesters</option>
                        <option value="1">1st Semester</option>
                        <option value="2">2nd Semester</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Curriculum Table -->
        <div class="default-table-container">
            <table class="default-table">
                <thead>
                    <tr>
                        <th>Program</th>
                        <th>Year Level</th>
                        <th>Semester</th>
                        <th>Total Courses</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="curriculumTableBody">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var group in Model)
                        {
                            string yearSuffix = group.YearLevel == 1 ? "st" :
                                              group.YearLevel == 2 ? "nd" :
                                              group.YearLevel == 3 ? "rd" : "th";

                            string semesterName = group.Semester == 1 ? "1st Semester" :
                                                 group.Semester == 2 ? "2nd Semester" :
                                                 group.Semester == 3 ? "Summer" : $"Semester {group.Semester}";

                            string groupId = $"{group.ProgramCode.ToLower()}-{group.YearLevel}-{group.Semester}";

                            <tr class="default-row curriculum-group-row"
                                data-program="@group.ProgramCode"
                                data-year="@group.YearLevel"
                                data-semester="@group.Semester"
                                data-group-id="@groupId"
                                data-program-id="@group.ProgramId">
                                <td class="default-info">
                                    <div class="user-details">
                                        <div class="user-name">@group.ProgramName</div>
                                        <div class="user-email">@group.ProgramCode</div>
                                    </div>
                                </td>
                                <td><span class="role-tag">@group.YearLevel@yearSuffix Year</span></td>
                                <td><span class="role-tag">@semesterName</span></td>
                                <td>
                                    <span class="course-count-badge">
                                        <i class="fas fa-book"></i>
                                        @group.CourseCount Course@(group.CourseCount != 1 ? "s" : "")
                                    </span>
                                </td>
                                <td class="action-buttons">
                                    <button class="action-btn view-btn"
                                            onclick="openCoursesModal('@group.ProgramCode', '@group.ProgramName', '@group.YearLevel@yearSuffix Year', '@semesterName', @group.ProgramId, @group.YearLevel, @group.Semester)"
                                            title="View Courses">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn edit-btn"
                                            onclick="editCurriculum('@groupId', '@group.ProgramCode', '@group.YearLevel', '@group.Semester')"
                                            title="Edit Curriculum">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button type="button" class="action-btn delete-btn"
                                            onclick="deleteCurriculum(@group.ProgramId, @group.YearLevel, @group.Semester, '@group.ProgramCode', '@group.ProgramName', '@group.YearLevel@yearSuffix Year', '@semesterName', @group.CourseCount)"
                                            title="Delete Curriculum">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr id="noDataRow">
                            <td colspan="5" class="text-center" style="padding: 3rem; color: var(--gray-text);">
                                <i class="fas fa-inbox" style="font-size: 3rem; color: #dee2e6; margin-bottom: 1rem; display: block;"></i>
                                <h5 style="margin-bottom: 0.5rem;">No curriculum courses assigned yet</h5>
                                <p style="margin: 0;">Click "Assign Courses" button to start adding courses to your curriculum.</p>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container">
            <div class="pagination-info">
                <span id="paginationInfo">Showing @(Model?.Count() ?? 0) of @(Model?.Count() ?? 0) curriculum groups</span>
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevBtn" disabled>
                    <i class="fa-solid fa-chevron-left"></i> Previous
                </button>
                <div class="pagination-numbers" id="paginationNumbers">
                    <button class="pagination-number active">1</button>
                </div>
                <button class="pagination-btn" id="nextBtn" disabled>
                    Next <i class="fa-solid fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Courses Modal -->
<div class="modal fade" id="coursesModal" tabindex="-1" aria-labelledby="coursesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coursesModalLabel">
                    <i class="fas fa-list"></i> <span id="modalCurriculumTitle">Courses</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Courses Table -->
                <div class="modal-table-container">
                    <table class="default-table">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Title</th>
                            </tr>
                        </thead>
                        <tbody id="modalCoursesTableBody">
                            <!-- Courses will be loaded here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<div id="alertContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; max-width: 320px;"></div>

@section scripts {
    <script src="~/Scripts/Custom/deleteHandler.js"></script>
    <script src="~/Scripts/Custom/deleteCurriculumHandler.js"></script>

    <script>
        // Fetch courses from backend via AJAX
        function openCoursesModal(programCode, programName, yearLevel, semester, programId, yearLevelNum, semesterNum) {
            $('#modalCurriculumTitle').text('Courses for ' + programCode + ' - ' + yearLevel + ' - ' + semester);
            const $tbody = $('#modalCoursesTableBody');
            $tbody.html('<tr><td colspan="2" class="text-center" style="padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading courses...</td></tr>');
            $('#coursesModal').modal('show');
            $.ajax({
                url: '@Url.Action("GetCurriculumCourses", "IT")',
                type: 'GET',
                data: {
                    programId: programId,
                    yearLevel: yearLevelNum,
                    semester: semesterNum
                },
                success: function (courses) {
                    $tbody.empty();

                    if (courses.length === 0) {
                        $tbody.append('<tr><td colspan="2" class="text-center" style="padding: 2rem; color: var(--gray-text);"><i class="fas fa-inbox" style="font-size: 2rem; color: #dee2e6; margin-bottom: 0.5rem; display: block;"></i><p style="margin: 0;">No courses assigned yet</p></td></tr>');
                    } else {
                        courses.forEach(function (course) {
                            $tbody.append('<tr class="modal-course-row"><td><span class="course-code-tag">' + course.code + '</span></td><td class="course-title-col">' + course.title + '</td></tr>');
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading courses:', error);
                    $tbody.html('<tr><td colspan="2" class="text-center" style="padding: 2rem; color: var(--danger-color);"><i class="fas fa-exclamation-triangle"></i> Error loading courses</td></tr>');
                }
            });
        }

        function editCurriculum(groupId, program, yearLevel, semester) {
            // Extract programId from the row
            const $row = $(`[data-group-id="${groupId}"]`);
            const programId = $row.data('program-id');
            
            window.location.href = '@Url.Action("EditAssignedCourses", "IT")?programId=' + programId + '&yearLevel=' + yearLevel + '&semester=' + semester;
        }

        $(document).ready(function () {
            // Search functionality
            $('#searchAssignments').on('keyup', function () {
                filterCurriculum();
            });

            // Filter functionality
            $('#programFilter, #yearLevelFilter, #semesterFilter').on('change', function () {
                filterCurriculum();
            });

            function filterCurriculum() {
                const searchTerm = $('#searchAssignments').val().toLowerCase();
                const programFilter = $('#programFilter').val();
                const yearFilter = $('#yearLevelFilter').val();
                const semesterFilter = $('#semesterFilter').val();

                $('.curriculum-group-row').each(function () {
                    const $row = $(this);
                    const programName = $row.find('.user-name').text().toLowerCase();
                    const programCode = $row.find('.user-email').text().toLowerCase();
                    const program = $row.data('program');
                    const year = $row.data('year').toString();
                    const semester = $row.data('semester').toString();

                    const matchesSearch = programName.includes(searchTerm) || programCode.includes(searchTerm);
                    const matchesProgram = !programFilter || program === programFilter;
                    const matchesYear = !yearFilter || year === yearFilter;
                    const matchesSemester = !semesterFilter || semester === semesterFilter;

                    if (matchesSearch && matchesProgram && matchesYear && matchesSemester) {
                        $row.show();
                    } else {
                        $row.hide();
                    }
                });

                updatePaginationInfo();
            }

            function updatePaginationInfo() {
                const visibleCount = $('.curriculum-group-row:visible').length;
                const totalCount = $('.curriculum-group-row').length;
                $('#paginationInfo').text('Showing ' + visibleCount + ' of ' + totalCount + ' curriculum groups');
            }

            // Make updatePaginationInfo globally accessible
            window.updatePaginationInfo = updatePaginationInfo;
        });
    </script>

    @if (TempData["SuccessMessage"] != null)
    {
        <script>
            $(function () {
                showAlert('success', '@TempData["SuccessMessage"]');
            });
        </script>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <script>
            $(function () {
                showAlert('danger', '@TempData["ErrorMessage"]');
            });
        </script>
    }
}

<style>
    .btn-create-class {
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 5px;
        margin-left: auto;
        padding: .75rem 2.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 20px;
        font-family: var(--archivo-plain-font);
    }

        .btn-create-class:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

    /* Course Count Badge */
    .course-count-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: #e8f5e8;
        color: var(--success-color);
        padding: 0.4rem 0.75rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        font-family: var(--archivo-plain-font);
    }

        .course-count-badge i {
            font-size: 0.9rem;
        }

    /* View Button Styling */
    .view-btn {
        background: var(--primary-color);
        color: white;
    }

        .view-btn:hover {
            background: var(--primary-hover);
        }

    /* Modal Styles */
    .modal-xl {
        max-width: 900px;
    }

    .modal-header .modal-title {
        font-family: var(--archivo-black-font);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }
    /* Modal Table Container */
    .modal-table-container {
        max-height: 500px;
        overflow-y: auto;
    }

        .modal-table-container .default-table th,
        .modal-table-container .default-table td {
            text-align: left;
        }

    .modal-course-row:hover {
        background: #f8f9fa;
    }

    .course-code-tag {
        display: inline-block;
        background: var(--light-blue);
        color: var(--primary-color);
        padding: 0.35rem 0.65rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
        font-family: var(--archivo-plain-font);
    }

    .course-title-col {
        font-weight: 600;
        color: var(--dark-primary-color);
        font-family: var(--archivo-plain-font);
        text-align: left;
    }

    .course-desc-col {
        color: var(--gray-text);
        font-size: 0.85rem;
        line-height: 1.5;
        font-family: var(--archivo-plain-font);
        max-width: 500px;
    }

    .material-count {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        color: var(--gray-text);
        font-size: 0.85rem;
        font-family: var(--archivo-plain-font);
    }

        .material-count i {
            color: var(--primary-color);
            font-size: 0.8rem;
        }

    .text-center {
        text-align: center !important;
    }

    /* Modal Footer */
    .modal-footer {
        border-top: 1px solid #dee2e6;
        padding: 1rem 1.5rem;
    }

        .modal-footer .btn {
            font-family: var(--archivo-plain-font);
        }

    /* Scrollbar Styling */
    .modal-table-container::-webkit-scrollbar {
        width: 8px;
    }

    .modal-table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .modal-table-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }

        .modal-table-container::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
</style>
