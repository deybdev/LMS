@model LMS.Models.Course

@{
    ViewBag.Title = "Create Classwork";
    int courseId = ViewBag.CourseId ?? Model.Id;
    ViewBag.ActiveTab = "Classwork";
}

<link rel="stylesheet" href="~/Content/teacherCourse.css" />
<link rel="stylesheet" href="~/Content/teacherViewCourse.css" />
<link rel="stylesheet" href="~/Content/classworkForm.css" />

<div class="admin-container">
    @Html.Partial("_BackButton")
    @Html.Partial("_CourseHeader", Model)
    @Html.Partial("_CourseNavigation", Model)

    <div class="tab-pane active">
        <div class="header-actions">
            <h2><i class="fa-solid fa-book"></i>Classwork and Activities</h2>
        </div>
        <div class="create-classwork-container">

            <form action="@Url.Action("CreateClasswork", "Teacher")" method="post" enctype="multipart/form-data" id="classworkForm">
                @Html.AntiForgeryToken()

                <input type="hidden" name="TeacherCourseId" value="@courseId" />

                <!-- Title, Classwork Type Row -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Title<span class="required">*</span></label>
                        <input type="text" name="title" required placeholder="Enter classwork title" />
                    </div>
                    <div class="form-group">
                        <label>Classwork Type<span class="required">*</span></label>
                        <select name="classworkType" id="classworkType" required>
                            <option value="">Select type</option>
                            <option value="Assignment">Assignment</option>
                            <option value="Quiz">Quiz</option>
                            <option value="Activity">Activity</option>
                            <option value="Project">Project</option>
                            <option value="Exam">Exam</option>
                        </select>
                    </div>
                </div>

                <!-- Publish Mode Selection -->
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Publish Mode<span class="required">*</span></label>
                        <div class="submission-mode-options">
                            <label class="mode-option">
                                <input type="radio" name="publishMode" id="publishNow" value="now" checked />
                                <div class="mode-card">
                                    <i class="fas fa-upload"></i>
                                    <h4>Upload Now</h4>
                                    <p>Make classwork available immediately</p>
                                </div>
                            </label>
                            <label class="mode-option">
                                <input type="radio" name="publishMode" id="publishScheduled" value="scheduled" />
                                <div class="mode-card">
                                    <i class="fas fa-clock"></i>
                                    <h4>Schedule</h4>
                                    <p>Set a future date to publish classwork</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Scheduled Publish Date (Hidden by default) -->
                <div class="form-row" id="scheduledDateRow" style="display: none;">
                    <div class="form-group full-width">
                        <label>Scheduled Publish Date<span class="required">*</span></label>
                        <input type="datetime-local" id="scheduledPublishDate" name="scheduledPublishDate" min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                        <small style="color: #666; display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Students will be able to see this classwork on the scheduled date.
                        </small>
                    </div>
                </div>

                <!-- Submission Mode Selection -->
                <div class="form-row" id="submissionModeRow" style="display: none;">
                    <div class="form-group full-width">
                        <label>Submission Mode<span class="required">*</span></label>
                        <div class="submission-mode-options">
                            <label class="mode-option">
                                <input type="radio" name="submissionMode" id="modeManual" value="manual" checked />
                                <div class="mode-card">
                                    <i class="fas fa-clipboard-question"></i>
                                    <h4>Manual Questions</h4>
                                    <p>Create questions for students to answer</p>
                                </div>
                            </label>
                            <label class="mode-option">
                                <input type="radio" name="submissionMode" id="modeFile" value="file" />
                                <div class="mode-card">
                                    <i class="fas fa-file-upload"></i>
                                    <h4>File Submission</h4>
                                    <p>Students upload files as their work</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Deadline Row -->
                <div class="deadline-points-row">
                    <div class="form-group">
                        <label>Deadline<span class="required">*</span></label>
                        <input type="datetime-local" id="deadlineInput" name="deadline" required min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                        <label style="margin-top: 8px; font-weight: normal; cursor: pointer;">
                            <input type="checkbox" id="noDueDateCheckbox" name="noDueDate" value="true" />
                            No due date
                        </label>
                    </div>
                    <div class="form-group" id="pointsGroup">
                        <label>Points<span class="required">*</span></label>
                        <input type="number" name="points" id="totalPoints" required placeholder="0" min="0" />
                    </div>
                </div>

                <!-- Description -->
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Description<span class="required">*</span></label>
                        <textarea name="description" required placeholder="Enter classwork description..."></textarea>
                    </div>
                </div>

                <!-- File Upload Area (for instructional materials) - Only in File Mode -->
                <div class="form-row" id="fileAttachmentSection" style="display: none;">
                    <div class="form-group full-width">
                        <label>Instructional Materials / Attachments</label>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                            </div>
                            <div class="upload-text">Click to upload or drag and drop</div>
                            <div class="upload-subtext">PDF, DOC, PPT, XLS files supported</div>
                            <button type="button" class="choose-file-btn" onclick="document.getElementById('fileInput').click()">
                                Choose file
                            </button>
                            <input type="file" id="fileInput" name="files" multiple class="file-input-hidden" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx" />
                        </div>
                        <div class="uploaded-files-list" id="uploadedFilesList"></div>
                    </div>
                </div>

                <!-- Questions Section (Manual Mode Only) -->
                <div id="questionsSection" style="display: none;">
                    <div class="section-header">
                        <div>
                            <h3><i class="fa-solid fa-clipboard-question"></i> Questions</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                Create questions for students to answer. Points will be calculated from questions.
                            </p>
                        </div>
                        <div class="question-type-selector">
                            <label>Add Question Type:</label>
                            <select id="questionTypeSelect">
                                <option value="">Choose type</option>
                                <option value="multipleChoice">Multiple Choice</option>
                                <option value="multipleAnswer">Multiple Answer</option>
                                <option value="trueFalse">True/False</option>
                                <option value="identification">Identification</option>
                                <option value="essay">Essay/Text</option>
                                <option value="fileUpload">File Upload</option>
                            </select>
                            <button type="button" class="btn-add-question" onclick="addQuestion()">
                                <i class="fa-solid fa-plus"></i> Add Question
                            </button>
                        </div>
                    </div>

                    <div id="questionsList" class="questions-list">
                        <!-- Questions will be added here dynamically -->
                    </div>

                    <input type="hidden" id="questionsData" name="questionsJson" />
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="window.location.href='@Url.Action("Classwork", "Teacher", new { id = courseId })'">
                        Cancel
                    </button>
                    <button type="submit" class="btn-submit">
                        <i class="fa-solid fa-check"></i> Create Classwork
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts {
    <script src="~/Scripts/Custom/classworkForm.js"></script>
    <script src="~/Scripts/Custom/questionBuilder.js"></script>
    <script>
        $(document).ready(function() {
            // Handle publish mode change
            $('input[name="publishMode"]').on('change', function() {
                var mode = $(this).val();
                if (mode === 'scheduled') {
                    $('#scheduledDateRow').slideDown();
                    $('#scheduledPublishDate').prop('required', true);
                } else {
                    $('#scheduledDateRow').slideUp();
                    $('#scheduledPublishDate').prop('required', false);
                }
            });

            // Validate scheduled date is after current time
            $('#classworkForm').on('submit', function(e) {
                var publishMode = $('input[name="publishMode"]:checked').val();
                if (publishMode === 'scheduled') {
                    var scheduledDate = new Date($('#scheduledPublishDate').val());
                    var now = new Date();
                    
                    if (scheduledDate <= now) {
                        e.preventDefault();
                        alert('Scheduled publish date must be in the future.');
                        return false;
                    }
                }
            });
        });
    </script>
}