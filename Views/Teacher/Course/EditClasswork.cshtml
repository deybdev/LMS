@model LMS.Models.Course

@{
    ViewBag.Title = "Edit Classwork";
    int courseId = ViewBag.CourseId ?? Model.Id;
    ViewBag.ActiveTab = "Classwork";
    
    // Determine publish mode
    bool isScheduled = ViewBag.IsScheduled ?? false;
    string publishMode = isScheduled ? "scheduled" : "now";
    
    // Determine if this is a Quiz/Exam type (for points display)
    string classworkType = ViewBag.ClassworkType?.ToString() ?? "";
    bool isQuizOrExam = classworkType == "Quiz" || classworkType == "Exam";
}

<link rel="stylesheet" href="~/Content/teacherCourse.css" />
<link rel="stylesheet" href="~/Content/teacherViewCourse.css" />
<link rel="stylesheet" href="~/Content/classworkForm.css" />
<link rel="stylesheet" href="~/Content/studentAssignment.css" />

<div class="admin-container">
    @Html.Partial("_BackButton")
    @Html.Partial("_CourseHeader", Model)
    @Html.Partial("_CourseNavigation", Model)

    <div class="tab-pane active">
        <div class="header-actions">
            <h2><i class="fa-solid fa-book"></i>Edit Classwork and Activities</h2>
        </div>
        <div class="create-classwork-container">

            <form action="@Url.Action("EditClasswork", "Teacher")" method="post" enctype="multipart/form-data" id="classworkForm">
                @Html.AntiForgeryToken()

                <input type="hidden" name="ClassworkId" value="@ViewBag.ClassworkId" />
                <input type="hidden" name="TeacherCourseId" value="@courseId" />
                <input type="hidden" id="selectedStudentIdsInput" name="selectedStudentIds" value="" />

                <!-- Title, Classwork Type Row -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Title<span class="required">*</span></label>
                        <input type="text" name="title" required placeholder="Enter classwork title" value="@ViewBag.ClassworkTitle" />
                    </div>
                    <div class="form-group">
                        <label>Classwork Type<span class="required">*</span></label>
                        <select name="classworkType" id="classworkType" required>
                            <option value="">Select type</option>
                            <option value="Assignment" @(ViewBag.ClassworkType == "Assignment" ? "selected" : "")>Assignment</option>
                            <option value="Quiz" @(ViewBag.ClassworkType == "Quiz" ? "selected" : "")>Quiz</option>
                            <option value="Activity" @(ViewBag.ClassworkType == "Activity" ? "selected" : "")>Activity</option>
                            <option value="Project" @(ViewBag.ClassworkType == "Project" ? "selected" : "")>Project</option>
                            <option value="Exam" @(ViewBag.ClassworkType == "Exam" ? "selected" : "")>Exam</option>
                        </select>
                    </div>
                </div>

                <!-- Publish Mode Selection -->
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Publish Mode<span class="required">*</span></label>
                        <div class="submission-mode-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="mode-option" style="width: 100%;">
                                <input type="radio" name="publishMode" id="publishNow" value="now" @(publishMode == "now" ? "checked" : "") />
                                <label for="publishNow" class="mode-card" style="width: 100%; display: block;">
                                    <i class="fas fa-upload"></i>
                                    <h4>Upload Now</h4>
                                    <p>Make classwork available immediately</p>
                                </label>
                            </div>
                            <div class="mode-option" style="width: 100%;">
                                <input type="radio" name="publishMode" id="publishScheduled" value="scheduled" @(publishMode == "scheduled" ? "checked" : "") />
                                <label for="publishScheduled" class="mode-card" style="width: 100%; display: block;">
                                    <i class="fas fa-clock"></i>
                                    <h4>Schedule</h4>
                                    <p>Set a future date to publish classwork</p>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scheduled Publish Date -->
                <div class="form-row" id="scheduledDateRow" style="@(publishMode == "scheduled" ? "" : "display: none;")">
                    <div class="form-group full-width">
                        <label>Scheduled Publish Date<span class="required">*</span></label>
                        <input type="datetime-local" id="scheduledPublishDate" name="scheduledPublishDate" 
                               value="@ViewBag.ScheduledPublishDate" 
                               min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" 
                               @(publishMode == "scheduled" ? "required" : "") />
                        <small style="color: #666; display: block; margin-top: 5px;">
                            <i class="fas fa-info-circle"></i> Students will be able to see this classwork on the scheduled date.
                        </small>
                    </div>
                </div>

                <!-- Hidden field for submission mode - always manual -->
                <input type="hidden" name="submissionMode" value="manual" />

                <!-- Deadline Row -->
                <div class="deadline-points-row">
                    <div class="form-group">
                        <label>Deadline<span class="required">*</span></label>
                        <input type="datetime-local" id="deadlineInput" name="deadline" required value="@ViewBag.ClassworkDeadline" min="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                        <label style="margin-top: 8px; font-weight: normal; cursor: pointer;">
                            <input type="checkbox" id="noDueDateCheckbox" name="noDueDate" value="true" @(ViewBag.HasNoDueDate == true ? "checked" : "") />
                            No due date
                        </label>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Description<span class="required">*</span></label>
                        <textarea name="description" required placeholder="Enter classwork description...">@ViewBag.ClassworkDescription</textarea>
                    </div>
                </div>

                <!-- Questions Section (Available for all types) -->
                <div id="questionsSection">

                    <div class="section-header">
                        <div>
                            <h3><i class="fa-solid fa-clipboard-question"></i> Questions</h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                Create questions for students to answer. Points will be calculated from questions.
                            </p>
                        </div>
                        <div class="question-type-selector">
                            <label>Add Question Type:</label>
                            <select id="questionTypeSelect">
                                <option value="">Choose type</option>
                                <option value="multipleChoice">Multiple Choice</option>
                                <option value="multipleAnswer">Multiple Answer</option>
                                <option value="trueFalse">True/False</option>
                                <option value="identification">Identification</option>
                                <option value="essay">Essay/Text</option>
                                <option value="fileUpload">File Upload</option>
                            </select>
                            <button type="button" class="btn-add-question" onclick="addQuestion()">
                                <i class="fa-solid fa-plus"></i> Add Question
                            </button>
                        </div>
                    </div>

                    <!-- CSV Import Section -->
                    <div class="csv-import-section" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; font-size: 14px; color: #333;">
                                    <i class="fas fa-file-csv"></i> Import Questions from CSV
                                </h4>
                                <small style="color: #666;">
                                    Bulk import questions - adds to any existing questions you've created manually
                                </small>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn-csv-template" onclick="downloadCSVTemplate()" 
                                        style="padding: 8px 16px; background: #fff; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                    <i class="fas fa-download"></i> Download Template
                                </button>
                                <button type="button" class="btn-import-csv" onclick="importQuestionsFromCSV()"
                                        style="padding: 8px 16px; background: var(--primary-color, #4CAF50); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.3s;">
                                    <i class="fas fa-file-import"></i> Import CSV
                                </button>
                            </div>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 4px; font-size: 12px; color: #555;">
                            <strong>💡 How it works:</strong> Add questions manually below, import from CSV, or do both! CSV imports will be added to your existing questions.
                            <br>
                            <strong>CSV Format:</strong> type, question, points, option1-5, correct_answer, case_sensitive, max_words
                            <br>
                            <strong>Supported Types:</strong> multiple choice, multiple answer, true/false, identification, essay, file upload
                        </div>
                    </div>

                    <div id="questionsList" class="questions-list">
                        <!-- Questions will be loaded here dynamically -->
                    </div>

                    <input type="hidden" id="questionsData" name="questionsJson" value='@ViewBag.ClassworkQuestionsJson' />
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="window.location.href='@Url.Action("Classwork", "Teacher", new { id = courseId })'">
                        Cancel
                    </button>
                    <button type="submit" class="btn-submit">
                        <i class="fa-solid fa-check"></i> Update Classwork
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var teacherCourseSectionId = @(ViewBag.TeacherCourseSectionId ?? 0);
        var isEditMode = true;
    </script>
    <script src="~/Scripts/Custom/classworkForm.js"></script>
    <script src="~/Scripts/Custom/questionBuilder.js"></script>
    <script>
        // Load existing questions on page load
        $(document).ready(function() {
            const questionsJson = $('#questionsData').val();
            if (questionsJson && questionsJson !== '') {
                try {
                    questions = JSON.parse(questionsJson);
                    questionCounter = questions.length > 0 ? Math.max(...questions.map(q => q.id)) : 0;
                    renderQuestions();
                } catch (e) {
                    console.error('Error parsing existing questions:', e);
                }
            }

            // Handle publish mode change
            $('input[name="publishMode"]').on('change', function() {
                var publishMode = $(this).val();
                if (publishMode === 'scheduled') {
                    $('#scheduledDateRow').slideDown();
                    $('#scheduledPublishDate').prop('required', true);
                } else {
                    $('#scheduledDateRow').slideUp();
                    $('#scheduledPublishDate').prop('required', false);
                }
            });

            // Form submission handler
            $('#classworkForm').on('submit', function(e) {
                var publishMode = $('input[name="publishMode"]:checked').val();
                if (publishMode === 'scheduled') {
                    var scheduledDate = new Date($('#scheduledPublishDate').val());
                    var now = new Date();
                    
                    if (scheduledDate <= now) {
                        e.preventDefault();
                        alert('Scheduled publish date must be in the future.');
                        return false;
                    }
                }

                // Serialize questions to JSON before validation
                if (typeof questions !== 'undefined' && questions.length > 0) {
                    $('#questionsData').val(JSON.stringify(questions));
                }

                // Validate that at least one question is added
                var questionsJson = $('#questionsData').val();
                
                if (!questionsJson || questionsJson === '[]' || questionsJson === '') {
                    e.preventDefault();
                    alert('Please add at least one question for this classwork.');
                    return false;
                }

                // Calculate and set total points from questions
                if (typeof questions !== 'undefined' && questions.length > 0) {
                    var totalPoints = questions.reduce(function(sum, q) { return sum + (q.points || 0); }, 0);
                    // Create a hidden input for points if it doesn't exist
                    if ($('#totalPoints').length === 0) {
                        $('<input>').attr({
                            type: 'hidden',
                            id: 'totalPoints',
                            name: 'points',
                            value: totalPoints
                        }).appendTo('#classworkForm');
                    } else {
                        $('#totalPoints').val(totalPoints);
                    }
                }
            });
        });
    </script>
    <style>
        .btn-csv-template:hover {
            background: #e9ecef !important;
            border-color: #adb5bd !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-import-csv:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        
        .csv-import-section {
            animation: slideInDown 0.3s ease-out;
        }
        
        @@keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
}


