@{
    ViewBag.Title = "Notifications";
}

<div class="admin-container">
    <div class="dashboard-header">
        <h1>Notifications</h1>
        <p>Get instant updates on announcements and classes.</p>
    </div>

    <div class="admin-content">
        <div class="notification-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="assignment">Assignments</button>
            <button class="filter-btn" data-filter="announcement">Announcements</button>
            <button class="filter-btn" data-filter="grade">Grades</button>
        </div>

        <div class="notifications-container" id="notificationsContainer"></div>

        <div class="empty-notifications" style="display: none;">
            <i class="fa-solid fa-bell-slash"></i>
            <h3>No Notifications</h3>
            <p>You're all caught up! Check back later for updates.</p>
        </div>
    </div>
</div>

<style>
/* styles unchanged except removed mark-all/delete */

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.notification-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--dark-primary-color);
    font-family: var(--archivo-black-font);
}

.notification-title i {
    color: var(--primary-color);
}

.notification-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.filter-btn {
    background: white;
    color: var(--gray-text);
    border: 1px solid var(--border-color);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s;
    font-family: var(--archivo-plain-font);
    font-weight: 500;
}

.filter-btn:hover,
.filter-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(24, 82, 172, 0.2);
}

.notifications-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.notification-item {
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    cursor: pointer;
}

.notification-item:hover {
    box-shadow: 0 4px 15px rgba(24,82,172,0.1);
    transform: translateY(-2px);
    border-color: var(--primary-color);
}

.notification-item.unread {
    background: var(--light-blue);
}

.notification-item.read {
    opacity: 0.95;
}

.notification-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.assignment-icon {
    background: #FFF3E0;
    color: #F57C00;
}

.grade-icon {
    background: #E8F5E8;
    color: var(--success-color);
}

.message-icon {
    background: #E3F2FD;
    color: #1976D2;
}

.announcement-icon {
    background: #FCE4EC;
    color: #C2185B;
}

.deadline-icon {
    background: #FFEBEE;
    color: var(--danger-color);
}

.notification-content {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-main {
    flex: 1;
}

.notification-title-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-primary-color);
    margin-bottom: 0.5rem;
    font-family: var(--archivo-plain-font);
}

.notification-message {
    color: var(--gray-text);
    margin-bottom: 0.5rem;
    line-height: 1.4;
    font-family: var(--archivo-plain-font);
}

.notification-date {
    font-size: 0.85rem;
    color: var(--gray-text);
    font-weight: 500;
    font-family: var(--archivo-plain-font);
}

.empty-notifications {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-text);
    font-family: var(--archivo-plain-font);
}

.empty-notifications i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
    color: var(--primary-color);
}

.empty-notifications h3 {
    margin-bottom: 1rem;
    color: var(--dark-primary-color);
    font-family: var(--archivo-black-font);
}

/* MOBILE RESPONSIVE IMPROVEMENTS */
@@media (max-width: 768px) {

    /* Filters: make horizontally scrollable */
    .notification-filters {
        display: flex;
        overflow-x: auto;
        white-space: nowrap;
        gap: 3px;
        padding-bottom: 6px;
        scrollbar-width: none;
    }

    .notifications-container{
        gap: .5rem;
    }

    .notification-filters::-webkit-scrollbar {
        display: none;
    }

    /* Filter buttons smaller */
    .filter-btn {
        padding: 6px 14px;
        font-size: 0.8rem;
        flex: 0 0 auto;
    }

    /* Notification item layout */
    .notification-item {
        flex-direction: row;
        padding: 1rem 0.85rem;
        gap: 0.75rem;
        align-items: flex-start;
    }

    /* Icon smaller */
    .notification-icon {
        width: 40px;
        height: 40px;
        margin-right: 0.75rem;
    }

    /* Stack content */
    .notification-content {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        width: 100%;
    }

    .notification-title-text {
        font-size: 1rem;
    }

    .notification-message {
        font-size: 0.85rem;
        line-height: 1.3;
    }

    .notification-date {
        font-size: 0.75rem;
    }

    .dashboard-header h1 {
        font-size: 1.4rem;
    }

    .empty-notifications {
        padding: 3rem 1.5rem;
    }

    .empty-notifications i {
        font-size: 3rem;
    }
}

.notifications-container.loading {
    opacity: 0.6;
    pointer-events: none;
}

@@keyframes slideOut {
    0% {
        transform: translateX(0);
        opacity: 1;
    }
    100% {
        transform: translateX(-100%);
        opacity: 0;
    }
}

.filter-btn:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.notifications-container {
    scroll-behavior: smooth;
}

</style>

<script>
// Parse .NET JSON date /Date( ticks )/ or ISO
function parseNetDate(value) {
    if (!value) return null;
    if (typeof value === 'string') {
        var m = /\/Date\((\d+)\)\//.exec(value);
        if (m) { return new Date(parseInt(m[1], 10)); }
        var d = new Date(value);
        return isNaN(d) ? null : d;
    }
    if (typeof value === 'number') { return new Date(value); }
    return null;
}

function pad(n) { return n < 10 ? '0' + n : '' + n; }
function formatDate(value) {
    var d = parseNetDate(value);
    if (!d) return '';
    var mm = pad(d.getMonth() + 1);
    var dd = pad(d.getDate());
    var yyyy = d.getFullYear();
    var hours = d.getHours();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12; if (hours === 0) hours = 12;
    var mins = pad(d.getMinutes());
    return mm + '/' + dd + '/' + yyyy + ' ' + hours + ':' + mins + ' ' + ampm;
}

function buildNotificationItem(n) {
    var uiType = (n.type === 'material') ? 'announcement' : (n.type || 'message');
    var isUnread = n.unread === true;

    var iconHtml = '<i class="fa-solid fa-circle-info"></i>';
    var iconClass = 'announcement-icon';
    if (uiType === 'assignment') { iconHtml = '<i class="fa-solid fa-clipboard-list"></i>'; iconClass = 'assignment-icon'; }
    else if (uiType === 'grade') { iconHtml = '<i class="fa-solid fa-star"></i>'; iconClass = 'grade-icon'; }
    else if (n.isDeadline) { iconHtml = '<i class="fa-solid fa-calendar-exclamation"></i>'; iconClass = 'deadline-icon'; }

    var wrapper = document.createElement('div');
    wrapper.className = 'notification-item ' + (isUnread ? 'unread' : 'read');
    wrapper.setAttribute('data-type', uiType);
    wrapper.setAttribute('data-id', n.id);
    if (n.url) { wrapper.setAttribute('data-url', n.url); }

    wrapper.innerHTML = `
    <div class="notification-icon ${iconClass}">${iconHtml}</div>
    <div class="notification-content">
        <div class="notification-main">
            <h4 class="notification-title-text">${n.title || 'Notification'}</h4>
            <p class="notification-message">${n.message || ''}</p>
            <span class="notification-date">${formatDate(n.date)}</span>
        </div>
    </div>`;

    // Click to navigate
    wrapper.addEventListener('click', function() {
        var url = this.getAttribute('data-url');
        if (url) { window.location.href = url; }
    });

    return wrapper;
}

function clearNotifications() { document.getElementById('notificationsContainer').innerHTML = ''; }

function renderNotifications(list) {
    const cont = document.getElementById('notificationsContainer');
    cont.classList.add('loading');
    clearNotifications();
    if (!list || list.length === 0) {
        cont.style.display = 'none';
        document.querySelector('.empty-notifications').style.display = 'block';
        cont.classList.remove('loading');
        return;
    }
    list.forEach(function(n) { cont.appendChild(buildNotificationItem(n)); });
    cont.style.display = 'flex';
    document.querySelector('.empty-notifications').style.display = 'none';
    cont.classList.remove('loading');
}

function loadNotifications(showToast) {
    const cont = document.getElementById('notificationsContainer');
    cont.classList.add('loading');
    fetch('@Url.Action("GetNotifications", "Student")', { method: 'GET', credentials: 'same-origin' })
        .then(r => r.json())
        .then(res => {
            if (!res || !res.success) {
                showAlert('danger', res && res.message ? res.message : 'Failed to load notifications');
                renderNotifications([]);
                return;
            }
            renderNotifications(res.notifications || []);
            if (showToast) { showAlert('success', 'Notifications refreshed'); }
        })
        .catch(err => {
            console.error(err);
            showAlert('danger', 'Error loading notifications');
            renderNotifications([]);
        });
}

// Filters
document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const filter = this.dataset.filter;
            const notifications = document.querySelectorAll('.notification-item');
            let visibleCount = 0;
            notifications.forEach(notification => {
                if (filter === 'all' || notification.dataset.type === filter) {
                    notification.style.display = 'flex';
                    visibleCount++;
                } else {
                    notification.style.display = 'none';
                }
            });
            if (visibleCount === 0 && filter !== 'all') { showAlert('info', 'No ' + filter + ' notifications found'); }
        });
    });

    loadNotifications(false);
});

function showAlert(type, message) {
    const alertId = 'alert-' + Date.now();
    const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show mb-3" 
             style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 10px;" role="alert">
            <i class="fa-solid fa-${
                type === 'success' ? 'check-circle' :
                type === 'danger' ? 'circle-exclamation' :
                type === 'warning' ? 'triangle-exclamation' : 'circle-info'
            } me-2"></i>
            <span style="font-family: var(--archivo-plain-font);">${message}</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    setTimeout(function() {
        const alert = document.getElementById(alertId);
        if (alert) { alert.style.opacity = '0'; alert.style.transform = 'translateY(-20px)'; setTimeout(() => alert.remove(), 300); }
    }, 5000);
}

function refreshNotifications() { loadNotifications(true); }
setInterval(refreshNotifications, 300000);
</script>

